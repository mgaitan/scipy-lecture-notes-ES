

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>2.1. Expresiones avanzadas en python (Advanced Python Constructs) &mdash; Scipy lecture notes</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2012.3 (EuroScipy 2012)',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="Scipy lecture notes" href="../../index.html" />
    <link rel="up" title="2. Temas avanzados" href="../index.html" />
    <link rel="next" title="2.2. Numpy avanzado" href="../advanced_numpy/index.html" />
    <link rel="prev" title="2. Temas avanzados" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../advanced_numpy/index.html" title="2.2. Numpy avanzado"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="../index.html" title="2. Temas avanzados"
             accesskey="P">previous</a> |</li>
        <li><a href="../../index.html">Scipy lecture notes</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">2. Temas avanzados</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
          <div class="body">
            
  <div class="section" id="expresiones-avanzadas-en-python-advanced-python-constructs">
<h1>2.1. Expresiones avanzadas en python (Advanced Python Constructs)<a class="headerlink" href="#expresiones-avanzadas-en-python-advanced-python-constructs" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">autor:</th><td class="field-body">Zbigniew Jędrzejewski-Szmek</td>
</tr>
</tbody>
</table>
<p>En este capítulo se tratan algunas características de Python que se
podrían considerar como avanzadas &#8212; en el sentido en que no todos los lenguajes
las tienen y, también, en el sentido en que son más útiles en bibliotecas y programas
más complejos pero no en el sentido de ser particularmente especialzadas o particularmente
complicadas.</p>
<p>Es importante subrayar que este capítulo trata, puramente, sobre el lenguaje en sí mismo
&#8212; acerca de características soportadas a través de sintaxis especial complementada
por funcionalidad de la biblioteca estándar (stdlib) de Python la cual
no podría ser implementada a través de inteligentes módulos externos.</p>
<p>El proceso de desarrollar el lenguaje de programación Python, su sintaxis,
es único porque es muy transparente, los cambios propuestos son evaluados
desde diferentes ángulos y discutidos de forma pública en listas de correo
y la decisión final trata de encontrar un balance entre la importancia de
los casos de uso previstos, la carga de incluir más características al lenguaje,
la consistencia con el resto de la sintaxis y si la variante propuesta es la
más sencilla de leer, escribir y entender. Este proceso se encuentra formalizado
en las propuestas de mejora de Python (<a class="reference external" href="http://www.python.org/dev/peps/">PEP</a>, de ahora en adelante, por sus
siglas en inglés, &#8216;Python Enhanced Proposals&#8217;). Como resultado, las características descritas
en este capítulo fueron añadidas posteriormente después de comprobar que
sirven para resolver problemas reales y de que su uso es lo más simple posible.</p>
<div class="contents local topic" id="contenidos-del-capitulo">
<p class="topic-title first">Contenidos del capítulo</p>
<ul class="simple">
<li><a class="reference internal" href="#iteradores-expresiones-generadoras-y-generadores" id="id1">Iteradores, expresiones generadoras y generadores</a><ul>
<li><a class="reference internal" href="#iteradores" id="id2">Iteradores</a></li>
<li><a class="reference internal" href="#expresiones-generadoras" id="id3">Expresiones generadoras</a></li>
<li><a class="reference internal" href="#generadores" id="id4">Generadores</a></li>
<li><a class="reference internal" href="#comunicacion-bidireccional" id="id5">Comunicación bidireccional</a></li>
<li><a class="reference internal" href="#encadenando-generadores" id="id6">Encadenando generadores</a></li>
</ul>
</li>
<li><a class="reference internal" href="#decoradores" id="id7">Decoradores</a><ul>
<li><a class="reference internal" href="#reemplazando-o-modificando-el-objeto-original" id="id8">Reemplazando o modificando el objeto original</a></li>
<li><a class="reference internal" href="#decoradores-implementados-como-clases-y-funciones" id="id9">Decoradores implementados como clases y funciones</a></li>
<li><a class="reference internal" href="#copiando-el-docstring-documentacion-y-otros-atributos-de-la-funcion-original" id="id10">Copiando el docstring (documentación) y otros atributos de la función original</a></li>
<li><a class="reference internal" href="#examples-in-the-standard-library" id="id11">Examples in the standard library</a></li>
<li><a class="reference internal" href="#deprecation-of-functions" id="id12">Deprecation of functions</a></li>
<li><a class="reference internal" href="#a-while-loop-removing-decorator" id="id13">A <tt class="docutils literal"><span class="pre">while</span></tt>-loop removing decorator</a></li>
<li><a class="reference internal" href="#a-plugin-registration-system" id="id14">A plugin registration system</a></li>
<li><a class="reference internal" href="#more-examples-and-reading" id="id15">More examples and reading</a></li>
</ul>
</li>
<li><a class="reference internal" href="#context-managers" id="id16">Context managers</a><ul>
<li><a class="reference internal" href="#catching-exceptions" id="id17">Catching exceptions</a></li>
<li><a class="reference internal" href="#using-generators-to-define-context-managers" id="id18">Using generators to define context managers</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="iteradores-expresiones-generadoras-y-generadores">
<h2><a class="toc-backref" href="#id1">2.1.1. Iteradores, expresiones generadoras y generadores</a><a class="headerlink" href="#iteradores-expresiones-generadoras-y-generadores" title="Permalink to this headline">¶</a></h2>
<div class="section" id="iteradores">
<h3><a class="toc-backref" href="#id2">2.1.1.1. Iteradores</a><a class="headerlink" href="#iteradores" title="Permalink to this headline">¶</a></h3>
<div class="sidebar">
<p class="first sidebar-title">Simplicidad</p>
<p>La duplicación del esfuerzo es un derroche y reemplazar
varios de los enfoques propios con una característica estándar,
normalmente, deriva en hacer las cosas más legibles además de más
interoperable.</p>
<blockquote class="last">
<div><em>Guido van Rossum</em> &#8212; <tt class="xref py py-obj docutils literal"><span class="pre">Añadiendo</span> <span class="pre">tipado</span> <span class="pre">estático</span> <span class="pre">opcional</span> <span class="pre">a</span> <span class="pre">Python</span></tt> (<a class="reference external" href="http://www.artima.com/weblogs/viewpost.jsp?thread=86641">Adding Optional Static Typing to Python</a>)</div></blockquote>
</div>
<p>Un iterador es un objeto adherido al &#8216;protocolo de iterador&#8217; (<a class="reference external" href="http://docs.python.org/dev/library/stdtypes.html#iterator-types">iterator protocol</a>)
&#8212; basicamente esto significa que tiene un método <a class="reference external" href="http://docs.python.org/2.7/library/stdtypes.html#iterator.next" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">next</span></tt></a> (&#8216;next&#8217; por siguiente),
el cual, cuando se le llama, devuelve la siguiente &#8216;pieza&#8217; (o &#8216;item&#8217;) en la secuencia y, cuando
no queda nada para ser devuelto, lanza la excepción
<a class="reference external" href="http://docs.python.org/2.7/library/exceptions.html#exceptions.StopIteration" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">StopIteration</span></tt></a>.</p>
<p>Un objeto iterador permite hacer bucles una única vez. Mantiene
el estado (posición) de una iteración individual o, explicado
de otra forma, cada bucle sobre una secuencia requiere un objeto
iterador individual. Esto significa que podemos iterar sobre la misma secuencia
más de una vez de forma concurrente. Separar la lógica de la iteración de la secuencia
permite tener más de una forma diferente de iterar.</p>
<p>La llamada del método <a class="reference external" href="http://docs.python.org/2.7/reference/datamodel.html#object.__iter__" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">__iter__</span></tt></a> en un contenedor es
la forma más sencilla de tener un objeto iterador. La función <a class="reference external" href="http://docs.python.org/2.7/library/functions.html#iter" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">iter</span></tt></a>
hace eso por nosotros ahorrándonos tiempo de tecleado.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>      <span class="c"># notas que ... varía: son objetos diferentes</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="nb">iter</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>                           
<div class="newline"></div><span class="go">&lt;listiterator object at ...&gt;</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">nums</span><span class="o">.</span><span class="n">__iter__</span><span class="p">()</span>                      
<div class="newline"></div><span class="go">&lt;listiterator object at ...&gt;</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">nums</span><span class="o">.</span><span class="n">__reversed__</span><span class="p">()</span>                  
<div class="newline"></div><span class="go">&lt;listreverseiterator object at ...&gt;</span>
<div class="newline"></div></pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>            <span class="c"># next(obj) simplemente llama a obj.next()</span>
<div class="newline"></div><span class="go">1</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">it</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<div class="newline"></div><span class="go">2</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
<div class="newline"></div><span class="go">3</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
<div class="newline"></div><span class="gt">Traceback (most recent call last):</span>
<div class="newline"></div>  File <span class="nb">&quot;&lt;stdin&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
<div class="newline"></div><span class="gr">StopIteration</span>
<div class="newline"></div></pre></div>
</div>
<p>Cuando se usa en un bucle, finalmente se llama a
<a class="reference external" href="http://docs.python.org/2.7/library/exceptions.html#exceptions.StopIteration" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">StopIteration</span></tt></a> y se provoca la finalización
del bucle. Pero si se invoca de forma explícita podemos ver que, una vez
que el iterador está &#8216;agotado&#8217;, al invocarlo nuevamente veremos que se lanza
la excepción comentada anteriormente.</p>
<p>La forma compuesta de bucle <tt class="xref py py-obj docutils literal"><span class="pre">for..in</span></tt> también usa el método
<tt class="docutils literal"><span class="pre">__iter__</span></tt>. Esto nos permite iniciar de forma transparente la
iteración sobre la secuencia. Pero si ya disponemos del iterador podemos
usarlo en el bucle <tt class="docutils literal"><span class="pre">for</span></tt> de la misma forma. Para conseguir esto, los iteradores
disponen del método <tt class="docutils literal"><span class="pre">__iter__</span></tt>, además del método <tt class="docutils literal"><span class="pre">next</span></tt>, el cual
devuelve el iterador (<tt class="docutils literal"><span class="pre">self</span></tt>).</p>
<p>El soporte para la iteración es dominante en Python:
todas las secuencias y contenedores desordenados que se encuentran
en la biblioteca estándar permiten esto. Este concepto se amplía
a otras cosas: e.g. los objetos <tt class="docutils literal"><span class="pre">fichero</span></tt> soporta la iteración sobre líneas.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/etc/fstab&#39;</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="ow">is</span> <span class="n">f</span><span class="o">.</span><span class="n">__iter__</span><span class="p">()</span>
<div class="newline"></div><span class="go">True</span>
<div class="newline"></div></pre></div>
</div>
<p>El <tt class="docutils literal"><span class="pre">fichero</span></tt> es un iterador en sí mismo y su método <tt class="docutils literal"><span class="pre">__iter__</span></tt> no crea un objeto separado:
solo se crea un hilo (thread) de acceso secuencial.</p>
</div>
<div class="section" id="expresiones-generadoras">
<h3><a class="toc-backref" href="#id3">2.1.1.2. Expresiones generadoras</a><a class="headerlink" href="#expresiones-generadoras" title="Permalink to this headline">¶</a></h3>
<p>Una segunda forma en la cual son creados objetos iteradores es a través de
<strong>expresiones generadoras</strong>, que son la base de la &#8216;comprensión de listas&#8217;
(<strong>list comprehensions</strong>). Para aumentar la claridad sobre el tema, una expresión generadora
siempre debe estar encerrada entre paréntesis(&#8216;()&#8217;), corchetes (&#8216;[]&#8217;) o mediante una expresión.
Si se usan paréntesis se crea un generador iterador. En cambio, si se usan corchetes, el proceso
se &#8216;cortocircuita&#8217; y obtenemos una <tt class="docutils literal"><span class="pre">lista</span></tt>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nums</span><span class="p">)</span>                    
<div class="newline"></div><span class="go">&lt;generator object &lt;genexpr&gt; at 0x...&gt;</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nums</span><span class="p">]</span>
<div class="newline"></div><span class="go">[1, 2, 3]</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nums</span><span class="p">)</span>
<div class="newline"></div><span class="go">[1, 2, 3]</span>
<div class="newline"></div></pre></div>
</div>
<p>En Python 2.7 y 3.x la sintaxis de la comprension de listas se extendió a
<strong>comprensión de diccionarios y conjuntos (sets)</strong>.
Se crea un <tt class="docutils literal"><span class="pre">conjunto</span></tt> cuando la expresión generadora se encuentra encerrada
por llaves (&#8216;{}&#8217;). Se crea un <tt class="docutils literal"><span class="pre">diccionario</span></tt> cuando la expresión generadora
contiene &#8220;pares&#8221; de la forma <tt class="docutils literal"><span class="pre">clave:valor</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="p">{</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)}</span>   
<div class="newline"></div><span class="go">set([0, 1, 2])</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)}</span>   
<div class="newline"></div><span class="go">{0: 0, 1: 1, 2: 4}</span>
<div class="newline"></div></pre></div>
</div>
<p>Si todavía estás usando alguna de las versiones previas de Python,
la sintaxis es un poco &#8216;peor&#8217;:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="nb">set</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="s">&#39;abc&#39;</span><span class="p">)</span>
<div class="newline"></div><span class="go">set([&#39;a&#39;, &#39;c&#39;, &#39;b&#39;])</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="nb">dict</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="nb">ord</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="s">&#39;abc&#39;</span><span class="p">)</span>
<div class="newline"></div><span class="go">{&#39;a&#39;: 97, &#39;c&#39;: 99, &#39;b&#39;: 98}</span>
<div class="newline"></div></pre></div>
</div>
<p>Las expresiones generadoras son bastante sencillas, no hay mucho más
que decir sobre ellas excepto un pequeño añadido: en versiones antiguas de Python
la variable de índexación (<tt class="docutils literal"><span class="pre">i</span></tt>) se filtrará (in old Pythons the index variable (i) would leak),
esto ha sido corregido en versiones &gt;= 3.</p>
</div>
<div class="section" id="generadores">
<h3><a class="toc-backref" href="#id4">2.1.1.3. Generadores</a><a class="headerlink" href="#generadores" title="Permalink to this headline">¶</a></h3>
<div class="sidebar">
<p class="first sidebar-title">Generadores</p>
<p>Un generador es una función que crea una
secuencia de resultados en lugar de una valor individual.</p>
<blockquote class="last">
<div><em>David Beazley</em> &#8212; <a class="reference external" href="http://www.dabeaz.com/coroutines/">A Curious Course on Coroutines and Concurrency</a></div></blockquote>
</div>
<p>Una tercera manera de crear objetos iteradores es llamando a la función
generador. Un <strong>generador</strong> es una función que contiene la palabra clave
<a class="reference external" href="http://docs.python.org/2.7/reference/simple_stmts.html#yield">yield</a>. Hay que destacar que la mera presencia de esta palabra
clave cambia completamente la naturaleza de esta función: esta declaración
<tt class="docutils literal"><span class="pre">yield</span></tt> no debe ser invocada, o incluso alcanzada, pero provoca que la
función sea clasificada como un generador. Cuando se llama a una función
normal se empiezan a ejecutar las instrucciones contenidas en el cuerpo
de esa misma función. Cuando se llama a un generador la ejecución para
después de la primera instrucción contenida en el cuerpo. Una invocación
de una función generadora crea un objeto generador, adheriéndose al
protocolo del iterador. De la misma forma que en las invocaciones a
funciones normales, se permiten invocaciones concurrentes y recursivas.</p>
<p>Cuando se llama a <tt class="docutils literal"><span class="pre">next</span></tt> la función se ejecuta hasta el primer <tt class="docutils literal"><span class="pre">yield</span></tt>.
Cada vez que una instrucción <tt class="docutils literal"><span class="pre">yield</span></tt> da un valor éste se convierte en
el valor de retorno de <tt class="docutils literal"><span class="pre">next</span></tt>. Después de ejecutar la instrucción
<tt class="docutils literal"><span class="pre">yield</span></tt>, la ejecución de la función se suspende.</p>
<div class="highlight-python"><pre>&gt;&gt;&gt; def f():
...   yield 1
...   yield 2
&gt;&gt;&gt; f()                                   
&lt;generator object f at 0x...&gt;
&gt;&gt;&gt; gen = f()
&gt;&gt;&gt; gen.next()
1
&gt;&gt;&gt; gen.next()
2
&gt;&gt;&gt; gen.next()
Traceback (most recent call last):
 File "&lt;stdin&gt;", line 1, in &lt;module&gt;
StopIteration</pre>
</div>
<p>Vamos a ver la vida de una invocación individual de una función generadora.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">print</span><span class="p">(</span><span class="s">&quot;-- start --&quot;</span><span class="p">)</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">yield</span> <span class="mi">3</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">print</span><span class="p">(</span><span class="s">&quot;-- middle --&quot;</span><span class="p">)</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">yield</span> <span class="mi">4</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">print</span><span class="p">(</span><span class="s">&quot;-- finished --&quot;</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">gen</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
<div class="newline"></div><span class="go">-- start --</span>
<div class="newline"></div><span class="go">3</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
<div class="newline"></div><span class="go">-- middle --</span>
<div class="newline"></div><span class="go">4</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>                            
<div class="newline"></div><span class="go">-- finished --</span>
<div class="newline"></div><span class="gt">Traceback (most recent call last):</span>
<div class="newline"></div> <span class="c">...</span>
<div class="newline"></div><span class="gr">StopIteration</span>
<div class="newline"></div></pre></div>
</div>
<p>Contrariamente a una función normal, donde la ejecución de
<tt class="docutils literal"><span class="pre">f()</span></tt> provocaría la inmediata ejecución del primer <tt class="docutils literal"><span class="pre">print</span></tt>,
<tt class="docutils literal"><span class="pre">gen</span></tt> se asigna sin ejecutar ninguna de las instrucciones
presentes en el cuerpo de la función. Solo cuando se invoca
<tt class="docutils literal"><span class="pre">gen.next()</span></tt> por <tt class="docutils literal"><span class="pre">next</span></tt>, se ejecuta la instrucción por encima del primer
<tt class="docutils literal"><span class="pre">yield</span></tt>. El segundo <tt class="docutils literal"><span class="pre">next</span></tt> muestra <tt class="docutils literal"><span class="pre">--</span> <span class="pre">middle</span> <span class="pre">--</span></tt> y la ejecución
se detiene en el segundo <tt class="docutils literal"><span class="pre">yield</span></tt>. El tercer <tt class="docutils literal"><span class="pre">next</span></tt> muestra
<tt class="docutils literal"><span class="pre">--</span> <span class="pre">finished</span> <span class="pre">--</span></tt> y se alcanza el final de la función. Debido a que
no se alcanza un nuevo <tt class="docutils literal"><span class="pre">yield</span></tt> se lanza una excepción.</p>
<p>¿Qué sucede con la función después de yield, cuando el control pasa al
cliente (&#8216;caller&#8217;)? El estado de cada generador se almacena en el objeto
generador. Desde el punto de vista de la función generadora, casi parece que
esté corriendo en un hilo (&#8216;thread&#8217;) separado pero esto es solo una iusión.:
la ejecución es estrictamente mono-hilo (&#8216;single-threaded&#8217;) pero el intérprete
mantiene y restablece el estado entre las peticiones para que
sea usado por el siguiente valor.</p>
<p>¿Por qué son útiles los generadores? Como se ha visto en las partes
sobre iteradores, una función generadora es únicamente una forma
diferente de crear un objeto iterador. Todo lo que se puede hacer
con instrucciones <tt class="docutils literal"><span class="pre">yield</span></tt> se puede hacer también con métodos <tt class="docutils literal"><span class="pre">next</span></tt>.
Sin embargo, usar una función y dejar que el intérprete haga su magia para
crear un iterador tiene sus ventajas. Una función puede ser mucho más
corta que tener que definir una clase con los métodos requeridos <tt class="docutils literal"><span class="pre">next</span></tt>
e <tt class="docutils literal"><span class="pre">__iter__</span></tt>. Y lo que es más importante, para el creador del
generador es más fácil entender el estado en el cual se mantienen
las variables locales en contraposición a atributos instanciados,
los cuales deben ser usados para pasar datos entre las invocaciones
consecutivas de <tt class="docutils literal"><span class="pre">next</span></tt> en el objeto iterador.</p>
<p>¿Una pregunta más amplia sería saber por qué los iteradores son útiles?
Cuando un iterador se usa en un bucle, el bucle se convierte en algo muy
simple. El código para inicializar el estado, para decidir si el bucle
se ha acabado y para encontrar el siguiente valor se extrae de forma
separada. Esto permite destacar el cuerpo del bucle &#8212; la parte interesante.
Además, es posible reusar el código del iterador en otras partes del código.</p>
</div>
<div class="section" id="comunicacion-bidireccional">
<h3><a class="toc-backref" href="#id5">2.1.1.4. Comunicación bidireccional</a><a class="headerlink" href="#comunicacion-bidireccional" title="Permalink to this headline">¶</a></h3>
<p>Cada declaración <tt class="docutils literal"><span class="pre">yield</span></tt> provoca que un valor sea pasado al cliente (&#8216;caller&#8217;).
Esta es la razón para la introducción de los generadores por el <span class="target" id="index-0"></span><a class="pep reference external" href="http://www.python.org/dev/peps/pep-0255"><strong>PEP 255</strong></a>
(implementado en Python 2.2).  Pero la comunicación en el sentido contrario
también es útil. Una forma obvia sería algún estado externo,
variable global o un objeto mutable compartido. La comunicación
directa es posible gracias al <span class="target" id="index-1"></span><a class="pep reference external" href="http://www.python.org/dev/peps/pep-0342"><strong>PEP 342</strong></a> (implementado in 2.5). Se logró
cambiando la antigua y aburrida declaración <tt class="docutils literal"><span class="pre">yield</span></tt> a una expresión.
Cuando el renerador continua la ejecución después de una declaración
<tt class="docutils literal"><span class="pre">yield</span></tt>, el cliente (&#8216;caller&#8217;) puede hacer una llamada a un método en
el objeto generador para pasar un valor <strong>hacia</strong> el generador, el cual es
devuelto después por la declaración <tt class="docutils literal"><span class="pre">yield</span></tt>, o un método diferente para
inyectar una excepción al generador.</p>
<p>El primero de los nuevos métodos es <a class="reference external" href="http://docs.python.org/2.7/reference/expressions.html#generator.send" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">send(value)</span></tt></a>, el cual
es similar a <a class="reference external" href="http://docs.python.org/2.7/reference/expressions.html#generator.next" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">next()</span></tt></a>, pero pasa un <tt class="docutils literal"><span class="pre">valor</span></tt> al generador
que será usado por el valor de la expresión <tt class="docutils literal"><span class="pre">yield</span></tt>. De hecho, <tt class="docutils literal"><span class="pre">g.next()</span></tt>
y <tt class="docutils literal"><span class="pre">g.send(None)</span></tt> son equivalentes.</p>
<p>El segundo de los nuevos métodos es <a class="reference external" href="http://docs.python.org/2.7/reference/expressions.html#generator.throw" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">throw(type,</span> <span class="pre">value=None,</span> <span class="pre">traceback=None)</span></tt></a>
que es equivalente a:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">raise</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span>
<div class="newline"></div></pre></div>
</div>
<p>en el lugar de la declaración <tt class="docutils literal"><span class="pre">yield</span></tt>.</p>
<p>A diferencia de <a class="reference external" href="http://docs.python.org/2.7/reference/simple_stmts.html#raise">raise</a> (que lanza una excepción desde el lugar actual
de ejecución), <tt class="docutils literal"><span class="pre">throw()</span></tt> primero reanuda el generador y solo entonces lanza
una excepción. La palabra throw (lanzar, tirar,...) fue seleccionada porque
sería indicativa de colocar la excepción en otro lugar y se asocia con excepciones
en otros lenguajes de programación.</p>
<p>¿Qué sucede cuando una excepción es lanzada dentro del generador?
Puede ser lanzada explícitamente o puede ser lanzada cuando se está
ejecutando alguna declaración o puede ser inyectada en el lugar de
una declaración <tt class="docutils literal"><span class="pre">yield</span></tt> mediante el método <tt class="docutils literal"><span class="pre">throw()</span></tt>. En
cualquier caso, cuando una excepción se propaga de la manera estándar:
podría ser interceptada por una cláusula <tt class="docutils literal"><span class="pre">except</span></tt> o <tt class="docutils literal"><span class="pre">finally</span></tt> o, si no,
provoca que se aborte la ejecución de la función generadora y se propaga
en el cliente (caller).</p>
<p>Para completar la sección, merece la pena mencionar que los iteradores
generadores también disponen de un método <a class="reference external" href="http://docs.python.org/2.7/reference/expressions.html#generator.close" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">close()</span></tt></a>,
el cual puede ser usado para forzar a un generador que de otra manera
sería capaz de proporcionar más valores
para terminar inmediatamente. Permite al método del generador <a class="reference external" href="http://docs.python.org/2.7/reference/datamodel.html#object.__del__" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">__del__</span></tt></a>
destruir objetos manteniendo el estado del generador.</p>
<p>Vamos a definir un generador que muestra lo que se pasa a través
de send y throw.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">itertools</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">g</span><span class="p">():</span>
<div class="newline"></div><span class="gp">... </span>    <span class="k">print</span> <span class="s">&#39;--start--&#39;</span>
<div class="newline"></div><span class="gp">... </span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
<div class="newline"></div><span class="gp">... </span>        <span class="k">print</span> <span class="s">&#39;--yielding </span><span class="si">%i</span><span class="s">--&#39;</span> <span class="o">%</span> <span class="n">i</span>
<div class="newline"></div><span class="gp">... </span>        <span class="k">try</span><span class="p">:</span>
<div class="newline"></div><span class="gp">... </span>            <span class="n">ans</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">i</span>
<div class="newline"></div><span class="gp">... </span>        <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
<div class="newline"></div><span class="gp">... </span>            <span class="k">print</span> <span class="s">&#39;--closing--&#39;</span>
<div class="newline"></div><span class="gp">... </span>            <span class="k">raise</span>
<div class="newline"></div><span class="gp">... </span>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<div class="newline"></div><span class="gp">... </span>            <span class="k">print</span> <span class="s">&#39;--yield raised </span><span class="si">%r</span><span class="s">--&#39;</span> <span class="o">%</span> <span class="n">e</span>
<div class="newline"></div><span class="gp">... </span>        <span class="k">else</span><span class="p">:</span>
<div class="newline"></div><span class="gp">... </span>            <span class="k">print</span> <span class="s">&#39;--yield returned </span><span class="si">%s</span><span class="s">--&#39;</span> <span class="o">%</span> <span class="n">ans</span>
<div class="newline"></div>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">it</span> <span class="o">=</span> <span class="n">g</span><span class="p">()</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
<div class="newline"></div><span class="go">--start--</span>
<div class="newline"></div><span class="go">--yielding 0--</span>
<div class="newline"></div><span class="go">0</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">it</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<div class="newline"></div><span class="go">--yield returned 11--</span>
<div class="newline"></div><span class="go">--yielding 1--</span>
<div class="newline"></div><span class="go">1</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">it</span><span class="o">.</span><span class="n">throw</span><span class="p">(</span><span class="ne">IndexError</span><span class="p">)</span>
<div class="newline"></div><span class="go">--yield raised IndexError()--</span>
<div class="newline"></div><span class="go">--yielding 2--</span>
<div class="newline"></div><span class="go">2</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">it</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<div class="newline"></div><span class="go">--closing--</span>
<div class="newline"></div></pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p><tt class="docutils literal"><span class="pre">next</span></tt> o <tt class="docutils literal"><span class="pre">__next__</span></tt>?</p>
<p class="last">En Python 2.x, el método iterador para recuperarel siguiente valor
se llama <a class="reference external" href="http://docs.python.org/2.7/library/stdtypes.html#iterator.next" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">next</span></tt></a>. Es invocado de forma explícita a
través del a función global <a class="reference external" href="http://docs.python.org/2.7/library/functions.html#next" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">next</span></tt></a>, lo que significa que debería
ser llamado``__next__``. Al igual que la función global <a class="reference external" href="http://docs.python.org/2.7/library/functions.html#iter" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">iter</span></tt></a> llama
a <a class="reference external" href="http://docs.python.org/2.7/library/stdtypes.html#iterator.__iter__" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">__iter__</span></tt></a>. Esta inconsistencia se ha corregido
en Python 3.x, donde <tt class="docutils literal"><span class="pre">it.next</span></tt> se convierte en <tt class="docutils literal"><span class="pre">it.__next__</span></tt>.
Para otros métodos del generador &#8212; <tt class="docutils literal"><span class="pre">send</span></tt> y <tt class="docutils literal"><span class="pre">throw</span></tt> &#8212; la
situación es más compleja because debido a que estos métodos no son
llamados implícitamente por el intérprete. No obstante, hay una propuesta
de extensión de la sintaxis que permite a <tt class="docutils literal"><span class="pre">continue</span></tt> tomar un
argumento que será pasado a <a class="reference external" href="http://docs.python.org/2.7/reference/expressions.html#generator.send" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">send</span></tt></a> en el iterador
del bucle. Si esta extensión es aceptada, es probable que
<tt class="docutils literal"><span class="pre">gen.send</span></tt> se convierta en <tt class="docutils literal"><span class="pre">gen.__send__</span></tt>. El último de los métodos
de un generador, <a class="reference external" href="http://docs.python.org/2.7/reference/expressions.html#generator.close" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">close</span></tt></a>, ha sido nombrado de forma
incorrecta de forma obvia ya que es invocado de forma implícita.</p>
</div>
</div>
<div class="section" id="encadenando-generadores">
<h3><a class="toc-backref" href="#id6">2.1.1.5. Encadenando generadores</a><a class="headerlink" href="#encadenando-generadores" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Esto ha sido implementado en Python 3.3 (<a class="reference external" href="http://docs.python.org/3/whatsnew/3.3.html#pep-380-syntax-for-delegating-to-a-subgenerator">PEP 380: Syntax for Delegating to a Subgenerator</a>).</p>
</div>
<p>Digamos que estamos escribiendo un generador y queremos arrojar un número
de valores generados por un segundo generador, un <strong>subgenerador</strong>.
Si la cesión de valores es la única inquietud, se podría realizar sin mucha dificultad
usando un bucle como</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">subgen</span> <span class="o">=</span> <span class="n">some_other_generator</span><span class="p">()</span>
<div class="newline"></div><span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">subgen</span><span class="p">:</span>
<div class="newline"></div>    <span class="k">yield</span> <span class="n">v</span>
<div class="newline"></div></pre></div>
</div>
<p>Sin embargo, si el subgenerador debe actuar adecuadamente con el
cliente (&#8216;caller&#8217;) en el caso de llamadas a <tt class="docutils literal"><span class="pre">send()</span></tt>, <tt class="docutils literal"><span class="pre">throw()</span></tt>
y <tt class="docutils literal"><span class="pre">close()</span></tt>, las cosas se transforman en algo más complejo.
La declaración <tt class="docutils literal"><span class="pre">yield</span></tt> tiene que ser custodiadas por una estructura
<a class="reference external" href="http://docs.python.org/2.7/reference/compound_stmts.html#try">try..except..finally</a> similar a la definida en la anterior
sección para &#8220;depurar&#8221; la función generadora. Este código se encuentra en
<span class="target" id="index-2"></span><a class="pep reference external" href="http://www.python.org/dev/peps/pep-0380#id13"><strong>PEP 380</strong></a>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">yield from</span> <span class="n">some_other_generator</span><span class="p">()</span>
<div class="newline"></div></pre></div>
</div>
<p>Esto se comporta como el bucle explícito mostrado más arriba, arrojando repetidamente
valores desde <tt class="docutils literal"><span class="pre">some_other_generator</span></tt> hasta que se agota, pero también transmite
<tt class="docutils literal"><span class="pre">send</span></tt>, <tt class="docutils literal"><span class="pre">throw</span></tt> y <tt class="docutils literal"><span class="pre">close</span></tt> al subgenerador.</p>
</div>
</div>
<div class="section" id="decoradores">
<h2><a class="toc-backref" href="#id7">2.1.2. Decoradores</a><a class="headerlink" href="#decoradores" title="Permalink to this headline">¶</a></h2>
<div class="sidebar">
<p class="first sidebar-title">Resumen</p>
<p>Esta maravillosa característica del lenguaje apareció casi pidiendo disculpas
y con la preocupación de que podría resultar poco útil.</p>
<blockquote class="last">
<div><em>Bruce Eckel</em> &#8212; An Introduction to Python Decorators</div></blockquote>
</div>
<p>Debido a que las funciones y clases son objetos, pueden ser distribuidos.
Debido a que son objetos mutables, pueden ser modificados. El acto de
alterar un objeto función o un objeto clase después de haber sido
construido pero antes de haber sido delimitado a su nombre se conoce como
decorador.</p>
<p>Hay dos cosas escondidas detrás de un &#8220;decorador&#8221; &#8212; una es la
función que se encarga de hacer el trabajo de decorador, i.e., la
que realiza el trabajo, y la otra es la expresión que se adhiere a
la sintaxis del decorador, i.e. una &#64; y el nombre de la función
decoradora.</p>
<p>Una función puede ser decorada usando la sintaxis de los decoradores
para funciones:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@decorator</span>             <span class="c"># ②</span>
<div class="newline"></div><span class="k">def</span> <span class="nf">function</span><span class="p">():</span>        <span class="c"># ①</span>
<div class="newline"></div>    <span class="k">pass</span>
<div class="newline"></div></pre></div>
</div>
<ul class="simple">
<li>Una función se define de la forma estándar. ①</li>
<li>Una expresión qu comienza con <tt class="docutils literal"><span class="pre">&#64;</span></tt> colocada antes de la definición
de la función es el decorador ②. TLa parte después de <tt class="docutils literal"><span class="pre">&#64;</span></tt> mdebe  ser
una expresión simple, normalmente será solo el nombre de una función
o de una clase. Esta parte será evaluada primero y, después, la función
definida debajo está lista, el decorador será llamado con objeto función recién
definido como único parámetro. El valor devuelto por el decorador
se adjunta al nombre original de la función.</li>
</ul>
<p>Los decoradores pueden aplicarse a funciones y clases. Para las clases, la semántica
es la misma &#8212; la definición de la clase original se usa como un argumento para llamar
al decorator y lo que sea que devuelva es asignado bajo el nombre original.</p>
<p>Antes de que fuera implementada la sintaxis del decorador (<span class="target" id="index-3"></span><a class="pep reference external" href="http://www.python.org/dev/peps/pep-0318"><strong>PEP 318</strong></a>), era
posible conseguir el mismo efecto asignando la función o la clase o una variable
temporal para después invocar al decorador explícitamente que, finalmente,
asignaba el valor devuelto al nombre de la función. Esto parece que implica
mucho tecleo, como realmente sucede, además de tener que repetir la función decorada
como una variable temporal al menos tres veces, lo que puede provocar errores.
El ejemplo anterior es equivalente a:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">function</span><span class="p">():</span>                  <span class="c"># ①</span>
<div class="newline"></div>    <span class="k">pass</span>
<div class="newline"></div><span class="n">function</span> <span class="o">=</span> <span class="n">decorator</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>   <span class="c"># ②</span>
<div class="newline"></div></pre></div>
</div>
<p>Los decoradores puden ser apilados &#8212; el orden de aplicación es de abajo a arriba
o de dentro hacia afuera. La semántica sería de la siguiente forma, la
función originalmente definida se usa como argumento para el primer decorador,
lo que sea que devuelva el primer decorador se usa como argumento para el
segundo decorador, ..., y lo que sea que devuelva el último decorador se
adjunta bajo el nombre de la función original.</p>
<p>La sintaxis de los decoradores fue elegida por su legibilidad.
Debido a que el decorador se especifica antes que la cabecera de
la función, resulta obvio que no es parte del cuerpo de la función
y está claro que solo puede operar sobre la función completa.
Ya que la expresión está prefijada con <tt class="docutils literal"><span class="pre">&#64;</span></tt> se encuentra resaltada
y es difícil pasarla por alto (&#8220;en tu cara&#8221;,
de acuerdo al PEP :) ). Cuando se aplica más de un decorador,
cada uno se emplaza en una línea para que sea de fácil lectura.</p>
<div class="section" id="reemplazando-o-modificando-el-objeto-original">
<h3><a class="toc-backref" href="#id8">2.1.2.1. Reemplazando o modificando el objeto original</a><a class="headerlink" href="#reemplazando-o-modificando-el-objeto-original" title="Permalink to this headline">¶</a></h3>
<p>Los decoradores pueden devolver tanto el mismo objeto función u objeto clase
como pueden devolver un objeto completamente diferente. En el primer caso,
el decorador puede aprovecharse del hecho de que un objeto función o un objeto clase
son mutables y se les pueden añadir atributos, e.g. se le podría añadir documentación
(<tt class="xref py py-obj docutils literal"><span class="pre">docstring</span></tt>) a una clase. Un decorador podría hacer algo útil incluso sin llegar
a modificar el objeto, por ejemplo, registrar la clase decorada en un registro global.
En el segundo caso, cualquier cosa es posible a priori: cuando algo diferente
es sustituido por la función o clase original, el nuevo objeto puede ser totalmente
diferente. Sin embargo, este comportamiento no refleja el propósito de los decoradores:
El objetivo principal de un decorador es alterar el objeto decorado, no realizar
algo impredecible. Por tanto, cuando una función se encuentra &#8220;decorada&#8221;, siendo reemplazada
con una función diferente, la nueva función, normalmente, llama a la función original, después
de realizar algo de trabajo de preparación. De la misma forma, cuando una clase ha sido
&#8220;decorada&#8221;, siendo reemplazado con otra clase, la nueva clase, normalmente, deriva de la
clase original. Cuando el propósito de la función decoradora (o decorador) es hacer algo
&#8220;siempre que se llama a la función decorada&#8221;, como por ejemplo registrar cada llamada
a la función decorada, solo podrían ser usados el segundo tipo de decoradores. Por otra
parte, si el primer caso es suficiente, sería recomendable usarlo puesto que es más
simple.</p>
</div>
<div class="section" id="decoradores-implementados-como-clases-y-funciones">
<h3><a class="toc-backref" href="#id9">2.1.2.2. Decoradores implementados como clases y funciones</a><a class="headerlink" href="#decoradores-implementados-como-clases-y-funciones" title="Permalink to this headline">¶</a></h3>
<p>El único requerimiento de los decoradores es el siguiente, solo pueden ser
llamados con un único argumento. Esto significa que los decoradores pueden
ser implementados como funciones normales o como clases con un método
<a class="reference external" href="http://docs.python.org/2.7/reference/datamodel.html#object.__call__" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">__call__</span></tt></a> o, en teoría, incluso como funciones lambda.</p>
<p>Vamos a comparar los usos de decorador como función o como clase.
La expresión decoradora (la parte que se encuentra inmediatamente
después de <tt class="docutils literal"><span class="pre">&#64;</span></tt>) puede ser solo un nombre o puede ser una llamada.
La forma de uso con solo el nombre es mejor (menos a escribir,
queda más limpio) pero solo es posible usarla cuando no se necesitan
argumentos para personalizar el decorador. Los decoradores escritos
como funciones pueden ser usados en los dos siguientes casos:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">simple_decorator</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">print</span> <span class="s">u&quot;haciendo una decoración&quot;</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">return</span> <span class="n">function</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="nd">@simple_decorator</span>
<div class="newline"></div><span class="gp">... </span><span class="k">def</span> <span class="nf">function</span><span class="p">():</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">print</span> <span class="s">u&quot;dentro de la función&quot;</span>
<div class="newline"></div><span class="go">haciendo una decoración</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">function</span><span class="p">()</span>
<div class="newline"></div><span class="go">dentro de la función</span>
<div class="newline"></div></pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">decorador_con_argumentos</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">print</span> <span class="s">u&quot;definiendo un decorador&quot;</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">def</span> <span class="nf">_decorador</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>      <span class="c"># en esta función interna, arg también está disponible</span>
<div class="newline"></div><span class="gp">... </span>      <span class="k">print</span> <span class="s">u&quot;haciendo una decoración,&quot;</span><span class="p">,</span> <span class="n">arg</span>
<div class="newline"></div><span class="gp">... </span>      <span class="k">return</span> <span class="n">function</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">return</span> <span class="n">_decorador</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="nd">@decorador_con_argumentos</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">)</span>
<div class="newline"></div><span class="gp">... </span><span class="k">def</span> <span class="nf">function</span><span class="p">():</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">print</span> <span class="s">u&quot;dentro de la función&quot;</span>
<div class="newline"></div><span class="go">definiendo un decorador</span>
<div class="newline"></div><span class="go">haciendo una decoración, abc</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">function</span><span class="p">()</span>
<div class="newline"></div><span class="go">dentro de la función</span>
<div class="newline"></div></pre></div>
</div>
<p>Los dos ejemplos de decoradores triviales mostrados en el código de más arriba
se encuentran en la categoría de decoradores que devuelven la función original.
Si tuvieran que devolver otra función, sería necesario otro nivel extra
de anidameniento. En el peor de los casos, tres niveles de funciones anidadas.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">reemplazando_decorador_con_argumentos</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">print</span> <span class="s">u&quot;definiendo el decorador&quot;</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">def</span> <span class="nf">_decorador</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>      <span class="c"># en esta función interna, arg también está disponible</span>
<div class="newline"></div><span class="gp">... </span>      <span class="k">print</span> <span class="s">u&quot;haciendo una decoración,&quot;</span><span class="p">,</span> <span class="n">arg</span>
<div class="newline"></div><span class="gp">... </span>      <span class="k">def</span> <span class="nf">_envoltorio</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>          <span class="k">print</span> <span class="s">u&quot;dentro del envoltorio,&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>
<div class="newline"></div><span class="gp">... </span>          <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<div class="newline"></div><span class="gp">... </span>      <span class="k">return</span> <span class="n">_envoltorio</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">return</span> <span class="n">_decorador</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="nd">@reemplazando_decorador_con_argumentos</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">)</span>
<div class="newline"></div><span class="gp">... </span><span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>    <span class="k">print</span> <span class="s">u&quot;dentro de la función,&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>
<div class="newline"></div><span class="gp">... </span>    <span class="k">return</span> <span class="mi">14</span>
<div class="newline"></div><span class="go">definiendo el decorador</span>
<div class="newline"></div><span class="go">haciendo la decoración, abc</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">function</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
<div class="newline"></div><span class="go">dentro del envoltorio, (11, 12) {}</span>
<div class="newline"></div><span class="go">dentro de la función, (11, 12) {}</span>
<div class="newline"></div><span class="go">14</span>
<div class="newline"></div></pre></div>
</div>
<p>La función <tt class="docutils literal"><span class="pre">_envoltorio</span></tt> (<tt class="docutils literal"><span class="pre">_wrapper</span></tt> en inglés) se defina para que
acepte todos los argumentos de las palabras clave (<tt class="xref py py-obj docutils literal"><span class="pre">keywords</span></tt>) posicionales.
En general, desconocemos los argumentos que podría aceptar la función decorada,
por tanto, la función envoltorio lo único que hacer es pasar todos los argumentos
a la función envuelta. Una consecuencia desafortunada es que la aparente lista
de argumentos es poco orientativa.</p>
<p>Comparados con los decoradores que se definen como una función, complejos decoradores
definidos como clases son más simples. Cuando se crea un objeto, al método
<a class="reference external" href="http://docs.python.org/2.7/reference/datamodel.html#object.__init__" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">__init__</span></tt></a> solo se le permite devolver <a class="reference external" href="http://docs.python.org/2.7/library/constants.html#None" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">None</span></tt></a>
y el tipo del objeto creado no puede ser modificado. Esto significa que
cuando un decorador se encuentra definido como una clase, no tiene mucho
sentido usar la forma sin argumentos: el objeto final decorado sería solamente
una instancia de la clase decorada, devuelto por la llamada al constructor,
lo cual no es muy útil. Por tanto, sería suficiente que discutiéramos decoradores
basados en clases en los que los argumentos son dados en la expresión decoradora</p>
<blockquote>
<div>y el método decorador <tt class="docutils literal"><span class="pre">__init__</span></tt> se usa para la construcción del decorador.</div></blockquote>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">clase_decoradora</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>      <span class="c"># este método será llamado en la expresión decoradora</span>
<div class="newline"></div><span class="gp">... </span>      <span class="k">print</span> <span class="s">&quot;in decorador init,&quot;</span><span class="p">,</span> <span class="n">arg</span>
<div class="newline"></div><span class="gp">... </span>      <span class="bp">self</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>      <span class="c"># Este método será llamado para que haga el trabajo</span>
<div class="newline"></div><span class="gp">... </span>      <span class="k">print</span> <span class="s">&quot;in decorator call,&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg</span>
<div class="newline"></div><span class="gp">... </span>      <span class="k">return</span> <span class="n">function</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">deco_instance</span> <span class="o">=</span> <span class="n">clase_decoradora</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">)</span>
<div class="newline"></div><span class="go">in decorator init, foo</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="nd">@deco_instance</span>
<div class="newline"></div><span class="gp">... </span><span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">print</span> <span class="s">u&quot;en la función,&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>
<div class="newline"></div><span class="go">en la función call, foo</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">function</span><span class="p">()</span>
<div class="newline"></div><span class="go">in function, () {}</span>
<div class="newline"></div></pre></div>
</div>
<p>Al contrario que lo que establecen las reglas normales (<span class="target" id="index-4"></span><a class="pep reference external" href="http://www.python.org/dev/peps/pep-0008"><strong>PEP 8</strong></a>),
los decoradores escritos como clases se comportan más como funciones y,
por tanto, su nombre, a veces, comienza con una letra minúscula.</p>
<p>En realidad, no tiene mucho sentido crear una clase nueva solo para tener
un decorador que devuelve la función original. Se supone que los objetos
mantienen el estado y estos decoradores son más útiles cuando el decorador
devuelve un nuevo objeto.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">replacing_decorator_class</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>      <span class="c"># Este método será llamado en la expresión decoradora</span>
<div class="newline"></div><span class="gp">... </span>      <span class="k">print</span> <span class="s">&quot;in decorator init,&quot;</span><span class="p">,</span> <span class="n">arg</span>
<div class="newline"></div><span class="gp">... </span>      <span class="bp">self</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>      <span class="c"># este método será llamado para hacer el trabajo</span>
<div class="newline"></div><span class="gp">... </span>      <span class="k">print</span> <span class="s">&quot;in decorator call,&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg</span>
<div class="newline"></div><span class="gp">... </span>      <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span>
<div class="newline"></div><span class="gp">... </span>      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrapper</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">def</span> <span class="nf">_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>      <span class="k">print</span> <span class="s">&quot;in the wrapper,&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>
<div class="newline"></div><span class="gp">... </span>      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">deco_instance</span> <span class="o">=</span> <span class="n">replacing_decorator_class</span><span class="p">(</span><span class="s">&#39;foo&#39;</span><span class="p">)</span>
<div class="newline"></div><span class="go">in decorator init, foo</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="nd">@deco_instance</span>
<div class="newline"></div><span class="gp">... </span><span class="k">def</span> <span class="nf">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">print</span> <span class="s">&quot;in function,&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>
<div class="newline"></div><span class="go">in decorator call, foo</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">function</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
<div class="newline"></div><span class="go">in the wrapper, (11, 12) {}</span>
<div class="newline"></div><span class="go">in function, (11, 12) {}</span>
<div class="newline"></div></pre></div>
</div>
<p>Un decorador como este puede hacer casi cualquier cosa, ya que puede modificar
el objeto función original y &#8216;machacar&#8217; los argumentos, llamar a la función
original o no y, después, &#8216;machacar&#8217; el valor de retorno.</p>
</div>
<div class="section" id="copiando-el-docstring-documentacion-y-otros-atributos-de-la-funcion-original">
<h3><a class="toc-backref" href="#id10">2.1.2.3. Copiando el docstring (documentación) y otros atributos de la función original</a><a class="headerlink" href="#copiando-el-docstring-documentacion-y-otros-atributos-de-la-funcion-original" title="Permalink to this headline">¶</a></h3>
<p>Cuando un decorador devuelve una nueva función que reemplaza a
la función original nos encontramos como consecuencia que, desafortunadamente,
hemos perdido el nombre original de la función, el docstring original y la lista
de argumentos originales. Podríamos traspasar todos esos atributos de la función original</p>
<p>When a new function is returned by the decorator to replace the
original function, an unfortunate consequence is that the original
function name, the original docstring, the original argument list are
lost. Those attributes of the original function can partially be &#8220;transplanted&#8221;
to the new function by setting <tt class="docutils literal"><span class="pre">__doc__</span></tt> (the docstring), <tt class="docutils literal"><span class="pre">__module__</span></tt>
and <tt class="docutils literal"><span class="pre">__name__</span></tt> (the full name of the function), and
<tt class="docutils literal"><span class="pre">__annotations__</span></tt> (extra information about arguments and the return
value of the function available in Python 3). This can be done
automatically by using <a class="reference external" href="http://docs.python.org/2.7/library/functools.html#functools.update_wrapper" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">functools.update_wrapper</span></tt></a>.</p>
<div class="sidebar">
<p class="first sidebar-title"><a class="reference external" href="http://docs.python.org/2.7/library/functools.html#functools.update_wrapper" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">functools.update_wrapper(wrapper,</span> <span class="pre">wrapped)</span></tt></a></p>
<p class="last">&#8220;Update a wrapper function to look like the wrapped function.&#8221;</p>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">functools</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">better_replacing_decorator_with_args</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">print</span> <span class="s">&quot;defining the decorator&quot;</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">def</span> <span class="nf">_decorator</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>      <span class="k">print</span> <span class="s">&quot;doing decoration,&quot;</span><span class="p">,</span> <span class="n">arg</span>
<div class="newline"></div><span class="gp">... </span>      <span class="k">def</span> <span class="nf">_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>          <span class="k">print</span> <span class="s">&quot;inside wrapper,&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>
<div class="newline"></div><span class="gp">... </span>          <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<div class="newline"></div><span class="gp">... </span>      <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">update_wrapper</span><span class="p">(</span><span class="n">_wrapper</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">return</span> <span class="n">_decorator</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="nd">@better_replacing_decorator_with_args</span><span class="p">(</span><span class="s">&quot;abc&quot;</span><span class="p">)</span>
<div class="newline"></div><span class="gp">... </span><span class="k">def</span> <span class="nf">function</span><span class="p">():</span>
<div class="newline"></div><span class="gp">... </span>    <span class="s">&quot;extensive documentation&quot;</span>
<div class="newline"></div><span class="gp">... </span>    <span class="k">print</span> <span class="s">&quot;inside function&quot;</span>
<div class="newline"></div><span class="gp">... </span>    <span class="k">return</span> <span class="mi">14</span>
<div class="newline"></div><span class="go">defining the decorator</span>
<div class="newline"></div><span class="go">doing decoration, abc</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">function</span>                           
<div class="newline"></div><span class="go">&lt;function function at 0x...&gt;</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">function</span><span class="o">.</span><span class="n">__doc__</span>
<div class="newline"></div><span class="go">extensive documentation</span>
<div class="newline"></div></pre></div>
</div>
<p>One important thing is missing from the list of attributes which can
be copied to the replacement function: the argument list. The default
values for arguments can be modified through the <tt class="docutils literal"><span class="pre">__defaults__</span></tt>,
<tt class="docutils literal"><span class="pre">__kwdefaults__</span></tt> attributes, but unfortunately the argument list
itself cannot be set as an attribute. This means that
<tt class="docutils literal"><span class="pre">help(function)</span></tt> will display a useless argument list which will be
confusing for the user of the function. An effective but ugly way
around this problem is to create the wrapper dynamically, using
<tt class="docutils literal"><span class="pre">eval</span></tt>. This can be automated by using the external <tt class="docutils literal"><span class="pre">decorator</span></tt>
module. It provides support for the <tt class="docutils literal"><span class="pre">decorator</span></tt> decorator, which takes a
wrapper and turns it into a decorator which preserves the function
signature.</p>
<p>To sum things up, decorators should always use <tt class="docutils literal"><span class="pre">functools.update_wrapper</span></tt>
or some other means of copying function attributes.</p>
</div>
<div class="section" id="examples-in-the-standard-library">
<h3><a class="toc-backref" href="#id11">2.1.2.4. Examples in the standard library</a><a class="headerlink" href="#examples-in-the-standard-library" title="Permalink to this headline">¶</a></h3>
<p>First, it should be mentioned that there&#8217;s a number of useful
decorators available in the standard library. There are three decorators
which really form a part of the language:</p>
<ul>
<li><p class="first"><a class="reference external" href="http://docs.python.org/2.7/library/functions.html#classmethod" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">classmethod</span></tt></a> causes a method to become a &#8220;class method&#8221;,
which means that it can be invoked without creating an instance of
the class. When a normal method is invoked, the interpreter inserts
the instance object as the first positional parameter,
<tt class="docutils literal"><span class="pre">self</span></tt>. When a class method is invoked, the class itself is given
as the first parameter, often called <tt class="docutils literal"><span class="pre">cls</span></tt>.</p>
<p>Class methods are still accessible through the class&#8217; namespace, so
they don&#8217;t pollute the module&#8217;s namespace. Class methods can be used
to provide alternative constructors:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Array</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="newline"></div>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<div class="newline"></div>        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
<div class="newline"></div>
<div class="newline"></div>    <span class="nd">@classmethod</span>
<div class="newline"></div>    <span class="k">def</span> <span class="nf">fromfile</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="nb">file</span><span class="p">):</span>
<div class="newline"></div>        <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
<div class="newline"></div>        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<div class="newline"></div></pre></div>
</div>
<p>This is cleaner then using a multitude of flags to <tt class="docutils literal"><span class="pre">__init__</span></tt>.</p>
</li>
<li><p class="first"><a class="reference external" href="http://docs.python.org/2.7/library/functions.html#staticmethod" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">staticmethod</span></tt></a> is applied to methods to make them &#8220;static&#8221;,
i.e. basically a normal function, but accessible through the class
namespace. This can be useful when the function is only needed
inside this class (its name would then be prefixed with <tt class="docutils literal"><span class="pre">_</span></tt>), or when we
want the user to think of the method as connected to the class,
despite an implementation which doesn&#8217;t require this.</p>
</li>
<li><p class="first"><a class="reference external" href="http://docs.python.org/2.7/library/functions.html#property" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">property</span></tt></a> is the pythonic answer to the problem of getters
and setters. A method decorated with <tt class="docutils literal"><span class="pre">property</span></tt> becomes a getter
which is automatically called on attribute access.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>  <span class="nd">@property</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>    <span class="s">&quot;an important attribute&quot;</span>
<div class="newline"></div><span class="gp">... </span>    <span class="k">return</span> <span class="s">&quot;a value&quot;</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">A</span><span class="o">.</span><span class="n">a</span>                                   
<div class="newline"></div><span class="go">&lt;property object at 0x...&gt;</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">A</span><span class="p">()</span><span class="o">.</span><span class="n">a</span>
<div class="newline"></div><span class="go">&#39;a value&#39;</span>
<div class="newline"></div></pre></div>
</div>
<p>In this example, <tt class="docutils literal"><span class="pre">A.a</span></tt> is an read-only attribute. It is also
documented: <tt class="docutils literal"><span class="pre">help(A)</span></tt> includes the docstring for attribute <tt class="docutils literal"><span class="pre">a</span></tt>
taken from the getter method. Defining <tt class="docutils literal"><span class="pre">a</span></tt> as a property allows it
to be a calculated on the fly, and has the side effect of making it
read-only, because no setter is defined.</p>
<p>To have a setter and a getter, two methods are required,
obviously. Since Python 2.6 the following syntax is preferred:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Rectangle</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="newline"></div>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge</span><span class="p">):</span>
<div class="newline"></div>        <span class="bp">self</span><span class="o">.</span><span class="n">edge</span> <span class="o">=</span> <span class="n">edge</span>
<div class="newline"></div>
<div class="newline"></div>    <span class="nd">@property</span>
<div class="newline"></div>    <span class="k">def</span> <span class="nf">area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="newline"></div>        <span class="sd">&quot;&quot;&quot;Computed area.</span>
<div class="newline"></div>
<div class="newline"></div><span class="sd">        Setting this updates the edge length to the proper value.</span>
<div class="newline"></div><span class="sd">        &quot;&quot;&quot;</span>
<div class="newline"></div>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge</span><span class="o">**</span><span class="mi">2</span>
<div class="newline"></div>
<div class="newline"></div>    <span class="nd">@area.setter</span>
<div class="newline"></div>    <span class="k">def</span> <span class="nf">area</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">area</span><span class="p">):</span>
<div class="newline"></div>        <span class="bp">self</span><span class="o">.</span><span class="n">edge</span> <span class="o">=</span> <span class="n">area</span> <span class="o">**</span> <span class="mf">0.5</span>
<div class="newline"></div></pre></div>
</div>
<p>The way that this works, is that the <tt class="docutils literal"><span class="pre">property</span></tt> decorator replaces
the getter method with a property object. This object in turn has
three methods, <tt class="docutils literal"><span class="pre">getter</span></tt>, <tt class="docutils literal"><span class="pre">setter</span></tt>, and <tt class="docutils literal"><span class="pre">deleter</span></tt>, which can be
used as decorators. Their job is to set the getter, setter and
deleter of the property object (stored as attributes <tt class="docutils literal"><span class="pre">fget</span></tt>,
<tt class="docutils literal"><span class="pre">fset</span></tt>, and <tt class="docutils literal"><span class="pre">fdel</span></tt>). The getter can be set like in the example
above, when creating the object. When defining the setter, we
already have the property object under <tt class="docutils literal"><span class="pre">area</span></tt>, and we add the
setter to it by using the <tt class="docutils literal"><span class="pre">setter</span></tt> method. All this happens when
we are creating the class.</p>
<p>Afterwards, when an instance of the class has been created, the
property object is special. When the interpreter executes attribute
access, assignment, or deletion, the job is delegated to the methods
of the property object.</p>
<p>To make everything crystal clear, let&#8217;s define a &#8220;debug&#8221; example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">D</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>   <span class="nd">@property</span>
<div class="newline"></div><span class="gp">... </span>   <span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>     <span class="k">print</span> <span class="s">&quot;getting&quot;</span><span class="p">,</span> <span class="mi">1</span>
<div class="newline"></div><span class="gp">... </span>     <span class="k">return</span> <span class="mi">1</span>
<div class="newline"></div><span class="gp">... </span>   <span class="nd">@a.setter</span>
<div class="newline"></div><span class="gp">... </span>   <span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>     <span class="k">print</span> <span class="s">&quot;setting&quot;</span><span class="p">,</span> <span class="n">value</span>
<div class="newline"></div><span class="gp">... </span>   <span class="nd">@a.deleter</span>
<div class="newline"></div><span class="gp">... </span>   <span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>     <span class="k">print</span> <span class="s">&quot;deleting&quot;</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">D</span><span class="o">.</span><span class="n">a</span>                                    
<div class="newline"></div><span class="go">&lt;property object at 0x...&gt;</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">D</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">fget</span>                               
<div class="newline"></div><span class="go">&lt;function a at 0x...&gt;</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">D</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">fset</span>                               
<div class="newline"></div><span class="go">&lt;function a at 0x...&gt;</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">D</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">fdel</span>                               
<div class="newline"></div><span class="go">&lt;function a at 0x...&gt;</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">d</span> <span class="o">=</span> <span class="n">D</span><span class="p">()</span>               <span class="c"># ... varies, this is not the same `a` function</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">d</span><span class="o">.</span><span class="n">a</span>
<div class="newline"></div><span class="go">getting 1</span>
<div class="newline"></div><span class="go">1</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">d</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mi">2</span>
<div class="newline"></div><span class="go">setting 2</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">d</span><span class="o">.</span><span class="n">a</span>
<div class="newline"></div><span class="go">deleting</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="n">d</span><span class="o">.</span><span class="n">a</span>
<div class="newline"></div><span class="go">getting 1</span>
<div class="newline"></div><span class="go">1</span>
<div class="newline"></div></pre></div>
</div>
<p>Properties are a bit of a stretch for the decorator syntax. One of the
premises of the decorator syntax &#8212; that the name is not duplicated
&#8212; is violated, but nothing better has been invented so far. It is
just good style to use the same name for the getter, setter, and
deleter methods.</p>
</li>
</ul>
<p>Some newer examples include:</p>
<ul class="simple">
<li><tt class="xref py py-obj docutils literal"><span class="pre">functools.lru_cache</span></tt> memoizes an arbitrary function
maintaining a limited cache of arguments:answer pairs (Python 3.2)</li>
<li><a class="reference external" href="http://docs.python.org/2.7/library/functools.html#functools.total_ordering" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">functools.total_ordering</span></tt></a> is a class decorator which fills in
missing ordering methods
(<a class="reference external" href="http://docs.python.org/2.7/reference/datamodel.html#object.__lt__" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">__lt__</span></tt></a>, <a class="reference external" href="http://docs.python.org/2.7/reference/datamodel.html#object.__gt__" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">__gt__</span></tt></a>,
<a class="reference external" href="http://docs.python.org/2.7/reference/datamodel.html#object.__le__" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">__le__</span></tt></a>, ...)
based on a single available one (Python 2.7).</li>
</ul>
</div>
<div class="section" id="deprecation-of-functions">
<h3><a class="toc-backref" href="#id12">2.1.2.5. Deprecation of functions</a><a class="headerlink" href="#deprecation-of-functions" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s say we want to print a deprecation warning on stderr on the
first invocation of a function we don&#8217;t like anymore. If we don&#8217;t want
to modify the function, we can use a decorator:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">deprecated</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="newline"></div>    <span class="sd">&quot;&quot;&quot;Print a deprecation warning once on first use of the function.</span>
<div class="newline"></div>
<div class="newline"></div><span class="sd">    &gt;&gt;&gt; @deprecated()                    # doctest: +SKIP</span>
<div class="newline"></div><span class="sd">    ... def f():</span>
<div class="newline"></div><span class="sd">    ...     pass</span>
<div class="newline"></div><span class="sd">    &gt;&gt;&gt; f()                              # doctest: +SKIP</span>
<div class="newline"></div><span class="sd">    f is deprecated</span>
<div class="newline"></div><span class="sd">    &quot;&quot;&quot;</span>
<div class="newline"></div>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<div class="newline"></div>        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
<div class="newline"></div>        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<div class="newline"></div>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrapper</span>
<div class="newline"></div>    <span class="k">def</span> <span class="nf">_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<div class="newline"></div>        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
<div class="newline"></div>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<div class="newline"></div>            <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;is deprecated&#39;</span>
<div class="newline"></div>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<div class="newline"></div></pre></div>
</div>
<p>It can also be implemented as a function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">deprecated</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<div class="newline"></div>    <span class="sd">&quot;&quot;&quot;Print a deprecation warning once on first use of the function.</span>
<div class="newline"></div>
<div class="newline"></div><span class="sd">    &gt;&gt;&gt; @deprecated                      # doctest: +SKIP</span>
<div class="newline"></div><span class="sd">    ... def f():</span>
<div class="newline"></div><span class="sd">    ...     pass</span>
<div class="newline"></div><span class="sd">    &gt;&gt;&gt; f()                              # doctest: +SKIP</span>
<div class="newline"></div><span class="sd">    f is deprecated</span>
<div class="newline"></div><span class="sd">    &quot;&quot;&quot;</span>
<div class="newline"></div>    <span class="n">count</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<div class="newline"></div>    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<div class="newline"></div>        <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
<div class="newline"></div>        <span class="k">if</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<div class="newline"></div>            <span class="k">print</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="s">&#39;is deprecated&#39;</span>
<div class="newline"></div>        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<div class="newline"></div>    <span class="k">return</span> <span class="n">wrapper</span>
<div class="newline"></div></pre></div>
</div>
</div>
<div class="section" id="a-while-loop-removing-decorator">
<h3><a class="toc-backref" href="#id13">2.1.2.6. A <tt class="docutils literal"><span class="pre">while</span></tt>-loop removing decorator</a><a class="headerlink" href="#a-while-loop-removing-decorator" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s say we have function which returns a lists of things, and this
list created by running a loop. If we don&#8217;t know how many objects will
be needed, the standard way to do this is something like:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">find_answers</span><span class="p">():</span>
<div class="newline"></div>    <span class="n">answers</span> <span class="o">=</span> <span class="p">[]</span>
<div class="newline"></div>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<div class="newline"></div>        <span class="n">ans</span> <span class="o">=</span> <span class="n">look_for_next_answer</span><span class="p">()</span>
<div class="newline"></div>        <span class="k">if</span> <span class="n">ans</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
<div class="newline"></div>            <span class="k">break</span>
<div class="newline"></div>        <span class="n">answers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
<div class="newline"></div>    <span class="k">return</span> <span class="n">answers</span>
<div class="newline"></div></pre></div>
</div>
<p>This is fine, as long as the body of the loop is fairly compact. Once
it becomes more complicated, as often happens in real code, this
becomes pretty unreadable. We could simplify this by using <tt class="docutils literal"><span class="pre">yield</span></tt>
statements, but then the user would have to explicitly call
<tt class="docutils literal"><span class="pre">list(find_answers())</span></tt>.</p>
<p>We can define a decorator which constructs the list for us:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">vectorized</span><span class="p">(</span><span class="n">generator_func</span><span class="p">):</span>
<div class="newline"></div>    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<div class="newline"></div>        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">generator_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
<div class="newline"></div>    <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">update_wrapper</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">generator_func</span><span class="p">)</span>
<div class="newline"></div></pre></div>
</div>
<p>Our function then becomes:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@vectorized</span>
<div class="newline"></div><span class="k">def</span> <span class="nf">find_answers</span><span class="p">():</span>
<div class="newline"></div>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
<div class="newline"></div>        <span class="n">ans</span> <span class="o">=</span> <span class="n">look_for_next_answer</span><span class="p">()</span>
<div class="newline"></div>        <span class="k">if</span> <span class="n">ans</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
<div class="newline"></div>            <span class="k">break</span>
<div class="newline"></div>        <span class="k">yield</span> <span class="n">ans</span>
<div class="newline"></div></pre></div>
</div>
</div>
<div class="section" id="a-plugin-registration-system">
<h3><a class="toc-backref" href="#id14">2.1.2.7. A plugin registration system</a><a class="headerlink" href="#a-plugin-registration-system" title="Permalink to this headline">¶</a></h3>
<p>This is a class decorator which doesn&#8217;t modify the class, but just
puts it in a global registry. It falls into the category of decorators
returning the original object:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">WordProcessor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="newline"></div>    <span class="n">PLUGINS</span> <span class="o">=</span> <span class="p">[]</span>
<div class="newline"></div>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<div class="newline"></div>        <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PLUGINS</span><span class="p">:</span>
<div class="newline"></div>            <span class="n">text</span> <span class="o">=</span> <span class="n">plugin</span><span class="p">()</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<div class="newline"></div>        <span class="k">return</span> <span class="n">text</span>
<div class="newline"></div>
<div class="newline"></div>    <span class="nd">@classmethod</span>
<div class="newline"></div>    <span class="k">def</span> <span class="nf">plugin</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">plugin</span><span class="p">):</span>
<div class="newline"></div>        <span class="n">cls</span><span class="o">.</span><span class="n">PLUGINS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>
<div class="newline"></div>
<div class="newline"></div><span class="nd">@WordProcessor.plugin</span>
<div class="newline"></div><span class="k">class</span> <span class="nc">CleanMdashesExtension</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="newline"></div>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
<div class="newline"></div>        <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&amp;mdash;&#39;</span><span class="p">,</span> <span class="s">u&#39;</span><span class="se">\N{em dash}</span><span class="s">&#39;</span><span class="p">)</span>
<div class="newline"></div></pre></div>
</div>
<p>Here we use a decorator to decentralise the registration of
plugins. We call our decorator with a noun, instead of a verb, because
we use it to declare that our class is a plugin for
<tt class="docutils literal"><span class="pre">WordProcessor</span></tt>. Method <tt class="docutils literal"><span class="pre">plugin</span></tt> simply appends the class to the
list of plugins.</p>
<p>A word about the plugin itself: it replaces HTML entity for em-dash
with a real Unicode em-dash character. It exploits the <a class="reference external" href="http://docs.python.org/2.7/reference/lexical_analysis.html#string-literals">unicode
literal notation</a> to insert a character by using its name in the
unicode database (&#8220;EM DASH&#8221;). If the Unicode character was inserted
directly, it would be impossible to distinguish it from an en-dash in
the source of a program.</p>
</div>
<div class="section" id="more-examples-and-reading">
<h3><a class="toc-backref" href="#id15">2.1.2.8. More examples and reading</a><a class="headerlink" href="#more-examples-and-reading" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><span class="target" id="index-5"></span><a class="pep reference external" href="http://www.python.org/dev/peps/pep-0318"><strong>PEP 318</strong></a> (function and method decorator syntax)</li>
<li><span class="target" id="index-6"></span><a class="pep reference external" href="http://www.python.org/dev/peps/pep-3129"><strong>PEP 3129</strong></a> (class decorator syntax)</li>
<li><a class="reference external" href="http://wiki.python.org/moin/PythonDecoratorLibrary">http://wiki.python.org/moin/PythonDecoratorLibrary</a></li>
<li><a class="reference external" href="http://docs.python.org/dev/library/functools.html">http://docs.python.org/dev/library/functools.html</a></li>
<li><a class="reference external" href="http://pypi.python.org/pypi/decorator">http://pypi.python.org/pypi/decorator</a></li>
<li>Bruce Eckel<ul>
<li><a class="reference external" href="http://www.artima.com/weblogs/viewpost.jsp?thread=240808">Decorators I</a>: Introduction to Python Decorators</li>
<li><a class="reference external" href="http://www.artima.com/weblogs/viewpost.jsp?thread=240845">Python Decorators II</a>: Decorator Arguments</li>
<li><a class="reference external" href="http://www.artima.com/weblogs/viewpost.jsp?thread=241209">Python Decorators III</a>: A Decorator-Based Build System</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="context-managers">
<h2><a class="toc-backref" href="#id16">2.1.3. Context managers</a><a class="headerlink" href="#context-managers" title="Permalink to this headline">¶</a></h2>
<p>A context manager is an object with <a class="reference external" href="http://docs.python.org/2.7/reference/datamodel.html#object.__enter__" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">__enter__</span></tt></a> and
<a class="reference external" href="http://docs.python.org/2.7/reference/datamodel.html#object.__exit__" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">__exit__</span></tt></a> methods which can be used in the <a class="reference external" href="http://docs.python.org/2.7/reference/compound_stmts.html#with">with</a>
statement:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">with</span> <span class="n">manager</span> <span class="k">as</span> <span class="n">var</span><span class="p">:</span>
<div class="newline"></div>    <span class="n">do_something</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
<div class="newline"></div></pre></div>
</div>
<p>is in the simplest case
equivalent to</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">var</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">__enter__</span><span class="p">()</span>
<div class="newline"></div><span class="k">try</span><span class="p">:</span>
<div class="newline"></div>    <span class="n">do_something</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
<div class="newline"></div><span class="k">finally</span><span class="p">:</span>
<div class="newline"></div>    <span class="n">manager</span><span class="o">.</span><span class="n">__exit__</span><span class="p">()</span>
<div class="newline"></div></pre></div>
</div>
<p>In other words, the context manager protocol defined in <span class="target" id="index-7"></span><a class="pep reference external" href="http://www.python.org/dev/peps/pep-0343"><strong>PEP 343</strong></a>
permits the extraction of the boring part of a
<a class="reference external" href="http://docs.python.org/2.7/reference/compound_stmts.html#try">try..except..finally</a> structure into a separate class
leaving only the interesting <tt class="docutils literal"><span class="pre">do_something</span></tt> block.</p>
<ol class="arabic simple">
<li>The <a class="reference external" href="http://docs.python.org/2.7/reference/datamodel.html#object.__enter__" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">__enter__</span></tt></a> method is called first.  It can
return a value which will be assigned to <tt class="docutils literal"><span class="pre">var</span></tt>.
The <tt class="docutils literal"><span class="pre">as</span></tt>-part is optional: if it isn&#8217;t present, the value
returned by <tt class="docutils literal"><span class="pre">__enter__</span></tt> is simply ignored.</li>
<li>The block of code underneath <tt class="docutils literal"><span class="pre">with</span></tt> is executed.  Just like with
<tt class="docutils literal"><span class="pre">try</span></tt> clauses, it can either execute successfully to the end, or
it can <a class="reference external" href="http://docs.python.org/2.7/reference/simple_stmts.html#break">break</a>, <a class="reference external" href="http://docs.python.org/2.7/reference/simple_stmts.html#continue`">continue`</a> or <a class="reference external" href="http://docs.python.org/2.7/reference/simple_stmts.html#return">return</a>, or
it can throw an exception. Either way, after the block is finished,
the <a class="reference external" href="http://docs.python.org/2.7/reference/datamodel.html#object.__exit__" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">__exit__</span></tt></a> method is called.
If an exception was thrown, the information about the exception is
passed to <tt class="docutils literal"><span class="pre">__exit__</span></tt>, which is described below in the next
subsection. In the normal case, exceptions can be ignored, just
like in a <tt class="docutils literal"><span class="pre">finally</span></tt> clause, and will be rethrown after
<tt class="docutils literal"><span class="pre">__exit__</span></tt> is finished.</li>
</ol>
<p>Let&#8217;s say we want to make sure that a file is closed immediately after
we are done writing to it:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">closing</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>    <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span>
<div class="newline"></div><span class="gp">... </span>  <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<div class="newline"></div><span class="gp">... </span>    <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<div class="newline"></div><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&#39;/tmp/file&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<div class="newline"></div><span class="gp">... </span>  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;the contents</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
<div class="newline"></div></pre></div>
</div>
<p>Here we have made sure that the <tt class="docutils literal"><span class="pre">f.close()</span></tt> is called when the
<tt class="docutils literal"><span class="pre">with</span></tt> block is exited. Since closing files is such a common
operation, the support for this is already present in the <tt class="docutils literal"><span class="pre">file</span></tt>
class. It has an <tt class="docutils literal"><span class="pre">__exit__</span></tt> method which calls <tt class="docutils literal"><span class="pre">close</span></tt> and can be
used as a context manager itself:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/tmp/file&#39;</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
<div class="newline"></div><span class="gp">... </span>  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;more contents</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
<div class="newline"></div></pre></div>
</div>
<p>The common use for <tt class="docutils literal"><span class="pre">try..finally</span></tt> is releasing resources. Various
different cases are implemented similarly: in the <tt class="docutils literal"><span class="pre">__enter__</span></tt>
phase the resource is acquired, in the <tt class="docutils literal"><span class="pre">__exit__</span></tt> phase it is
released, and the exception, if thrown, is propagated. As with files,
there&#8217;s often a natural operation to perform after the object has been
used and it is most convenient to have the support built in. With each
release, Python provides support in more places:</p>
<ul class="simple">
<li>all file-like objects:<ul>
<li><a class="reference external" href="http://docs.python.org/2.7/library/functions.html#file" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">file</span></tt></a> ➔ automatically closed</li>
<li><a class="reference external" href="http://docs.python.org/2.7/library/fileinput.html#fileinput" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">fileinput</span></tt></a>, <a class="reference external" href="http://docs.python.org/2.7/library/tempfile.html#tempfile" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">tempfile</span></tt></a> (py &gt;= 3.2)</li>
<li><a class="reference external" href="http://docs.python.org/2.7/library/bz2.html#bz2.BZ2File" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">bz2.BZ2File</span></tt></a>, <a class="reference external" href="http://docs.python.org/2.7/library/gzip.html#gzip.GzipFile" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">gzip.GzipFile</span></tt></a>,
<a class="reference external" href="http://docs.python.org/2.7/library/tarfile.html#tarfile.TarFile" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">tarfile.TarFile</span></tt></a>, <a class="reference external" href="http://docs.python.org/2.7/library/zipfile.html#zipfile.ZipFile" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">zipfile.ZipFile</span></tt></a></li>
<li><a class="reference external" href="http://docs.python.org/2.7/library/ftplib.html#ftplib" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">ftplib</span></tt></a>, <a class="reference external" href="http://docs.python.org/2.7/library/nntplib.html#nntplib" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">nntplib</span></tt></a> ➔ close connection (py &gt;= 3.2 or 3.3)</li>
</ul>
</li>
<li>locks<ul>
<li><a class="reference external" href="http://docs.python.org/2.7/library/multiprocessing.html#multiprocessing.RLock" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">multiprocessing.RLock</span></tt></a> ➔ lock and unlock</li>
<li><a class="reference external" href="http://docs.python.org/2.7/library/multiprocessing.html#multiprocessing.Semaphore" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">multiprocessing.Semaphore</span></tt></a></li>
<li><a class="reference external" href="http://docs.python.org/2.7/library/stdtypes.html#memoryview" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">memoryview</span></tt></a> ➔ automatically release (py &gt;= 3.2 and 2.7)</li>
</ul>
</li>
<li><a class="reference external" href="http://docs.python.org/2.7/library/decimal.html#decimal.localcontext" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">decimal.localcontext</span></tt></a> ➔ modify precision of computations temporarily</li>
<li><a class="reference external" href="http://docs.python.org/2.7/library/_winreg.html#_winreg.OpenKey" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">_winreg.PyHKEY</span></tt></a> ➔ open and close hive key</li>
<li><a class="reference external" href="http://docs.python.org/2.7/library/warnings.html#warnings.catch_warnings" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">warnings.catch_warnings</span></tt></a> ➔ kill warnings temporarily</li>
<li><a class="reference external" href="http://docs.python.org/2.7/library/contextlib.html#contextlib.closing" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">contextlib.closing</span></tt></a> ➔ the same as the example above, call <tt class="docutils literal"><span class="pre">close</span></tt></li>
<li>parallel programming<ul>
<li><tt class="xref py py-obj docutils literal"><span class="pre">concurrent.futures.ThreadPoolExecutor</span></tt> ➔ invoke in parallel then kill thread pool (py &gt;= 3.2)</li>
<li><tt class="xref py py-obj docutils literal"><span class="pre">concurrent.futures.ProcessPoolExecutor</span></tt> ➔ invoke in parallel then kill process pool (py &gt;= 3.2)</li>
<li><tt class="xref py py-obj docutils literal"><span class="pre">nogil</span></tt> ➔ solve the GIL problem temporarily (cython only :( )</li>
</ul>
</li>
</ul>
<div class="section" id="catching-exceptions">
<h3><a class="toc-backref" href="#id17">2.1.3.1. Catching exceptions</a><a class="headerlink" href="#catching-exceptions" title="Permalink to this headline">¶</a></h3>
<p>When an exception is thrown in the <tt class="docutils literal"><span class="pre">with</span></tt>-block, it is passed as
arguments to <tt class="docutils literal"><span class="pre">__exit__</span></tt>. Three arguments are used, the same as
returned by <a class="reference external" href="http://docs.python.org/2.7/library/sys.html#sys.exc_info" title="(in Python v2.7)"><tt class="xref py py-func docutils literal"><span class="pre">sys.exc_info()</span></tt></a>: type, value, traceback. When no
exception is thrown, <tt class="docutils literal"><span class="pre">None</span></tt> is used for all three arguments.  The
context manager can &#8220;swallow&#8221; the exception by returning a true value
from <tt class="docutils literal"><span class="pre">__exit__</span></tt>. Exceptions can be easily ignored, because if
<tt class="docutils literal"><span class="pre">__exit__</span></tt> doesn&#8217;t use <tt class="docutils literal"><span class="pre">return</span></tt> and just falls of the end,
<tt class="docutils literal"><span class="pre">None</span></tt> is returned, a false value, and therefore the exception is
rethrown after <tt class="docutils literal"><span class="pre">__exit__</span></tt> is finished.</p>
<p>The ability to catch exceptions opens interesting possibilities. A
classic example comes from unit-tests &#8212; we want to make sure that
some code throws the right kind of exception:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">assert_raises</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<div class="newline"></div>    <span class="c"># based on pytest and unittest.TestCase</span>
<div class="newline"></div>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
<div class="newline"></div>        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
<div class="newline"></div>    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="newline"></div>        <span class="k">pass</span>
<div class="newline"></div>    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
<div class="newline"></div>        <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
<div class="newline"></div>            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;exception expected&#39;</span><span class="p">)</span>
<div class="newline"></div>        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">):</span>
<div class="newline"></div>            <span class="k">return</span> <span class="bp">True</span> <span class="c"># swallow the expected exception</span>
<div class="newline"></div>        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;wrong exception type&#39;</span><span class="p">)</span>
<div class="newline"></div>
<div class="newline"></div><span class="k">with</span> <span class="n">assert_raises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
<div class="newline"></div>    <span class="p">{}[</span><span class="s">&#39;foo&#39;</span><span class="p">]</span>
<div class="newline"></div></pre></div>
</div>
</div>
<div class="section" id="using-generators-to-define-context-managers">
<h3><a class="toc-backref" href="#id18">2.1.3.2. Using generators to define context managers</a><a class="headerlink" href="#using-generators-to-define-context-managers" title="Permalink to this headline">¶</a></h3>
<p>When discussing <a href="#id19"><span class="problematic" id="id20">generators_</span></a>, it was said that we prefer generators to
iterators implemented as classes because they are shorter, sweeter,
and the state is stored as local, not instance, variables. On the
other hand, as described in <a href="#id21"><span class="problematic" id="id22">`Bidirectional communication`_</span></a>, the flow
of data between the generator and its caller can be bidirectional.
This includes exceptions, which can be thrown into the
generator. We would like to implement context managers as special
generator functions. In fact, the generator protocol was designed to
support this use case.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@contextlib.contextmanager</span>
<div class="newline"></div><span class="k">def</span> <span class="nf">some_generator</span><span class="p">(</span><span class="o">&lt;</span><span class="n">arguments</span><span class="o">&gt;</span><span class="p">):</span>
<div class="newline"></div>    <span class="o">&lt;</span><span class="n">setup</span><span class="o">&gt;</span>
<div class="newline"></div>    <span class="k">try</span><span class="p">:</span>
<div class="newline"></div>        <span class="k">yield</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span>
<div class="newline"></div>    <span class="k">finally</span><span class="p">:</span>
<div class="newline"></div>        <span class="o">&lt;</span><span class="n">cleanup</span><span class="o">&gt;</span>
<div class="newline"></div></pre></div>
</div>
<p>The <a class="reference external" href="http://docs.python.org/2.7/library/contextlib.html#contextlib.contextmanager" title="(in Python v2.7)"><tt class="xref py py-obj docutils literal"><span class="pre">contextlib.contextmanager</span></tt></a> helper takes a generator and turns it
into a context manager. The generator has to obey some rules which are
enforced by the wrapper function &#8212; most importantly it must
<tt class="docutils literal"><span class="pre">yield</span></tt> exactly once. The part before the <tt class="docutils literal"><span class="pre">yield</span></tt> is executed from
<tt class="docutils literal"><span class="pre">__enter__</span></tt>, the block of code protected by the context manager is
executed when the generator is suspended in <tt class="docutils literal"><span class="pre">yield</span></tt>, and the rest is
executed in <tt class="docutils literal"><span class="pre">__exit__</span></tt>. If an exception is thrown, the interpreter
hands it to the wrapper through <tt class="docutils literal"><span class="pre">__exit__</span></tt> arguments, and the
wrapper function then throws it at the point of the <tt class="docutils literal"><span class="pre">yield</span></tt>
statement. Through the use of generators, the context manager is
shorter and simpler.</p>
<p>Let&#8217;s rewrite the <tt class="docutils literal"><span class="pre">closing</span></tt> example as a generator:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@contextlib.contextmanager</span>
<div class="newline"></div><span class="k">def</span> <span class="nf">closing</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
<div class="newline"></div>    <span class="k">try</span><span class="p">:</span>
<div class="newline"></div>        <span class="k">yield</span> <span class="n">obj</span>
<div class="newline"></div>    <span class="k">finally</span><span class="p">:</span>
<div class="newline"></div>        <span class="n">obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<div class="newline"></div></pre></div>
</div>
<p>Let&#8217;s rewrite the <tt class="docutils literal"><span class="pre">assert_raises</span></tt> example as a generator:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nd">@contextlib.contextmanager</span>
<div class="newline"></div><span class="k">def</span> <span class="nf">assert_raises</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
<div class="newline"></div>    <span class="k">try</span><span class="p">:</span>
<div class="newline"></div>        <span class="k">yield</span>
<div class="newline"></div>    <span class="k">except</span> <span class="nb">type</span><span class="p">:</span>
<div class="newline"></div>        <span class="k">return</span>
<div class="newline"></div>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">value</span><span class="p">:</span>
<div class="newline"></div>        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;wrong exception type&#39;</span><span class="p">)</span>
<div class="newline"></div>    <span class="k">else</span><span class="p">:</span>
<div class="newline"></div>        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s">&#39;exception expected&#39;</span><span class="p">)</span>
<div class="newline"></div></pre></div>
</div>
<p>Here we use a decorator to turn generator functions into context managers!</p>
<p><div style="clear: both"></div></p>
</div>
</div>
</div>


          </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../advanced_numpy/index.html" title="2.2. Numpy avanzado"
             >next</a></li>
        <li class="right" >
          <a href="../index.html" title="2. Temas avanzados"
             >previous</a> |</li>
        <li><a href="../../index.html">Scipy lecture notes</a> &raquo;</li>
          <li><a href="../index.html" >2. Temas avanzados</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>